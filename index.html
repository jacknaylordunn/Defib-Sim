<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoll X Series Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

        // You can get this from your Firebase project settings
        const firebaseConfig = {
         apiKey: "AIzaSyBOncSGXi8-QpT108a_JPZtntloCXkcCJQ",
         authDomain: "defib-sim.firebaseapp.com",
         projectId: "defib-sim",
         storageBucket: "defib-sim.firebasestorage.app",
         messagingSenderId: "487758771885",
         appId: "1:487758771885:web:a52f726a930f53fb8ff824",
         measurementId: "G-HE67GWPE0Q"
        };
        
        const finalFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;

        const app = initializeApp(finalFirebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.firebaseServices = { auth, db, onSnapshot, doc, setDoc, updateDoc, arrayUnion, serverTimestamp };
        window.initializeAppState(signInAnonymously, onAuthStateChanged);
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .zoll-body-blue { background-color: #003C71; }
        .zoll-bezel-gray { background-color: #B4B8B8; }
        .zoll-screen-bg { background-color: #1a1a1a; }
        .zoll-text-green { color: #32CD32; }
        .zoll-text-yellow { color: #FFD700; }
        .zoll-text-blue { color: #00BFFF; }
        .zoll-text-pink { color: #FF69B4; }
        
        .btn-green { background-color: #00A859; }
        .btn-yellow { background-color: #F39C12; }
        .btn-red { background-color: #E74C3C; }
        .btn-gray { background-color: #4A4A4A; border: 1px solid #666;}

        .quick-access-btn {
            background-color: #2D2D2D; border-top: 2px solid #555; border-left: 2px solid #555;
            border-right: 2px solid #111; border-bottom: 2px solid #111; color: white;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 8px; width: 80px; height: 60px; font-weight: 600;
        }
        .quick-access-btn:active {
            border-top: 2px solid #111; border-left: 2px solid #111;
            border-right: 2px solid #555; border-bottom: 2px solid #555;
        }

        .control-btn {
             background-color: #2D2D2D; border-top: 2px solid #555; border-left: 2px solid #555;
            border-right: 2px solid #111; border-bottom: 2px solid #111; color: white;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 8px; width: 70px; height: 50px;
        }
        .control-btn:active {
             border-top: 2px solid #111; border-left: 2px solid #111;
             border-right: 2px solid #555; border-bottom: 2px solid #555;
        }
        .nav-btn {
            background-color: #2D2D2D; border-top: 2px solid #555; border-left: 2px solid #555;
            border-right: 2px solid #111; border-bottom: 2px solid #111;
        }
        .nav-btn:active {
            border-top: 2px solid #111; border-left: 2px solid #111;
            border-right: 2px solid #555; border-bottom: 2px solid #555;
        }

        .therapy-btn {
            color: black; font-weight: 700; padding: 1rem 1.5rem; border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2), inset 0 -4px 0 rgba(0,0,0,0.3); transition: all 0.1s ease;
        }
         .therapy-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 3px rgba(0,0,0,0.2), inset 0 -2px 0 rgba(0,0,0,0.3);
        }
        
        .shock-btn {
             width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center;
             justify-content: center; font-size: 2.5rem; font-weight: 900; color: white;
             border-width: 4px; border-color: #B91C1C;
             box-shadow: 0 5px 10px rgba(0,0,0,0.3), inset 0 -5px 0 rgba(0,0,0,0.4);
        }
        .shock-btn:active:not(:disabled) {
             transform: translateY(2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3), inset 0 -2px 0 rgba(0,0,0,0.4);
        }

        @keyframes blink { 50% { filter: brightness(0.7); } }
        .blinking { animation: blink 1s linear infinite; }

        .highlighted-param {
            outline: 3px solid #00BFFF;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-gray-800 flex items-center justify-center min-h-screen p-4">
    
    <div id="session-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-700 p-8 rounded-lg shadow-2xl text-white w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Zoll X Simulator Control</h2>
            <p class="mb-6">Enter a session ID to connect to a controller. Use the same ID on your controller device.</p>
            <input type="text" id="session-id-input" class="w-full p-3 bg-gray-800 rounded-md border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., training-room-1">
            <button id="connect-btn" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md transition-colors">Connect & Start Simulation</button>
             <p class="mt-4 text-xs text-gray-400">If the ID doesn't exist, a new session will be created with default vitals.</p>
        </div>
    </div>

    <!-- Main Zoll Device Body -->
    <div id="zoll-device" class="hidden w-full max-w-4xl bg-zoll-bezel-gray p-2 rounded-2xl shadow-2xl border-4 border-gray-900">
        <div class="flex flex-col">
            <div class="h-12 bg-gray-500 rounded-t-lg mb-1 mx-24 flex items-center justify-center relative">
                <div class="absolute top-2 right-4 flex gap-2 items-center">
                    <div id="power-led" class="w-4 h-4 bg-green-500 rounded-full border-2 border-gray-700"></div>
                    <div id="rfu-indicator" class="text-green-400 font-bold text-lg">✓</div>
                </div>
            </div>
            <div class="bg-zoll-body-blue p-3 rounded-xl flex flex-col">
                <div class="flex gap-2">
                    <!-- Quick Access Keys -->
                    <div class="flex">
                        <div id="quick-access-panel-1" class="flex flex-col justify-between space-y-1.5">
                            <button id="btn-lead" class="quick-access-btn"><span>I, II, III...</span></button>
                            <button id="btn-12-lead" class="quick-access-btn"><span class="font-bold text-xl">12</span><span class="text-xs -mt-1">LEAD</span></button>
                            <button id="btn-co2" class="quick-access-btn"><span class="text-lg">CO₂</span><div class="w-2.5 h-2.5 rounded-full bg-green-500 mt-1"></div></button>
                            <button id="btn-sync" class="quick-access-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22a7 7 0 0 0 7-7h-2a5 5 0 0 1-5 5v2z"></path><path d="M19 13a7 7 0 0 0-7-7v2a5 5 0 0 1 5 5h2z"></path><path d="M5 13a7 7 0 0 0 7 7v-2a5 5 0 0 1-5-5H5z"></path><path d="M12 5a7 7 0 0 0-7 7h2a5 5 0 0 1 5-5V5z"></path><line x1="12" y1="1" x2="12" y2="4"></line><line x1="12" y1="20" x2="12" y2="23"></line><line x1="4" y1="12" x2="1" y2="12"></line><line x1="23" y1="12" x2="20" y2="12"></line></svg><span class="text-xs mt-1">SYNC</span></button>
                            <button id="btn-rx" class="quick-access-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-4"></path><rect x="8" y="1" width="8" height="4" rx="1" ry="1"></rect><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></svg><span class="text-xs mt-1">Rx</span></button>
                            <button id="btn-more" class="quick-access-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 9.5V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-3.5"></path><path d="M10 12H2"></path><path d="m6 16 4-4-4-4"></path><path d="m22 12-4-4v2h-4v4h4v2l4-4z"></path></svg><span class="text-xs mt-1">More</span></button>
                        </div>
                        <div id="quick-access-panel-2" class="hidden flex-col justify-between space-y-1.5">
                            <button id="btn-manual-mode" class="quick-access-btn"><span>MANUAL<br>MODE</span></button>
                            <button id="btn-alarms" class="quick-access-btn"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="yellow" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg><span>ALARMS</span></button>
                            <button id="btn-log" class="quick-access-btn"><span>LOG</span></button>
                            <button id="btn-setup" class="quick-access-btn"><span>SETUP</span></button>
                            <button id="btn-summary" class="quick-access-btn"><span>SUMMARY</span></button>
                            <button id="btn-back" class="quick-access-btn"><span>BACK</span></button>
                        </div>
                    </div>
                    
                    <!-- Main Display Screen -->
                    <div id="screen" class="zoll-screen-bg flex-1 p-1 rounded-lg border-2 border-black relative overflow-hidden">
                        
                        <div id="monitor-view" class="h-full flex-col">
                            <div class="flex justify-between items-center text-xs text-gray-400 px-2">
                                <span><span id="date-time-val"></span></span>
                                <span class="bg-blue-800 text-white px-2 py-0.5 rounded text-sm">Adult</span>
                                <div class="flex items-center gap-2">
                                    <div class="w-7 h-3.5 border border-green-500 rounded flex items-center p-0.5"><div class="bg-green-500 h-full w-full rounded-sm"></div></div>
                                    <span id="elapsed-time-val">00:00:00</span>
                                </div>
                            </div>
                            <div id="alarm-message-container" class="text-center font-bold text-lg h-7 my-1"></div>
                            <div class="flex-grow relative">
                                <canvas id="waveform-canvas" class="w-full h-full"></canvas>
                                <div id="pacer-overlay" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-black bg-opacity-70 p-4 rounded-lg text-white text-center">
                                    <div class="text-lg font-bold">PACING</div>
                                    <div>Rate: <span id="pacer-rate-val">--</span> ppm</div>
                                    <div>Output: <span id="pacer-output-val">--</span> mA</div>
                                </div>
                            </div>
                            <div id="vitals-container" class="grid grid-cols-4 gap-1 p-1">
                                <div id="hr-val-container" class="nav-target bg-black border border-green-800 text-center rounded p-1"><span class="text-sm text-gray-400">HR</span><div id="hr-val" class="text-5xl font-black zoll-text-green leading-none">--</div></div>
                                <div id="nibp-val-container" class="nav-target bg-black border border-blue-800 text-center rounded p-1"><span class="text-sm text-gray-400">NIBP</span><div id="nibp-val" class="text-3xl font-black zoll-text-blue leading-tight">--/--</div><div id="nibp-mean-val" class="text-lg text-gray-400">(--)</div></div>
                                <div id="etco2-val-container" class="nav-target bg-black border border-pink-800 text-center rounded p-1"><span class="text-sm text-gray-400">EtCO2</span><div id="etco2-val" class="text-5xl font-black zoll-text-pink leading-none">--</div><span class="text-sm text-gray-400">BR <span id="resp-val">--</span></span></div>
                                <div id="spo2-val-container" class="nav-target bg-black border border-yellow-800 text-center rounded p-1 relative"><span class="text-sm text-gray-400">SpO2 %</span><div id="spo2-val" class="text-5xl font-black zoll-text-yellow leading-none">--</div><div class="absolute right-1 bottom-1 w-1.5 h-8 bg-gray-600 rounded-sm"><div id="pleth-bar" class="w-full bg-yellow-400 rounded-sm" style="height: 80%;"></div></div></div>
                            </div>
                        </div>

                        <div id="manual-defib-view" class="hidden h-full flex">
                            <div class="flex-grow flex flex-col">
                                <div class="flex-grow relative">
                                   <canvas id="manual-defib-canvas" class="w-full h-full"></canvas>
                                </div>
                                <div id="manual-defib-status-msg" class="h-16 bg-yellow-500 text-black text-center flex flex-col justify-center font-bold text-2xl rounded">
                                    <!-- Content generated by JS -->
                                </div>
                            </div>
                            <div id="energy-ladder" class="w-24 bg-gray-800 flex flex-col-reverse text-center text-white font-bold p-1 space-y-1 space-y-reverse">
                                <!-- Energy levels generated by JS -->
                            </div>
                        </div>

                        <div id="aed-view" class="hidden h-full flex flex-col items-center justify-center text-white p-4">
                           <!-- Content generated by JS -->
                        </div>

                        <canvas id="12-lead-canvas" class="hidden absolute inset-0 w-full h-full"></canvas>
                         <div id="lead-select-menu" class="hidden absolute top-1/4 left-1/4 w-1/2 bg-gray-800 bg-opacity-90 border-2 border-gray-500 rounded-lg p-4 text-white">
                            <h3 class="text-lg font-bold text-center mb-4">Select Lead Source</h3>
                            <div id="lead-options" class="grid grid-cols-3 gap-2 text-center"></div>
                        </div>
                    </div>

                    <!-- Right Side Controls -->
                    <div class="flex flex-col justify-between items-center space-y-2">
                        <button class="control-btn" id="btn-alarm-silence"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c1.1 0 2-.9 2-2v-1H10v1c0 1.1.9 2 2 2z"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path><path d="M2 8c0-2.2.7-4.3 2-6"></path><path d="M22 8a10 10 0 0 0-2-6"></path><path d="M12 2a10 10 0 0 0-8 4"></path><path d="M12 2a10 10 0 0 1 8 4"></path><path d="m2 2 20 20"></path></svg><span class="text-xs">Silence</span></button>
                        <div class="flex flex-col items-center gap-1">
                            <button id="btn-nav-up" class="nav-btn w-10 h-10 rounded-full flex items-center justify-center text-2xl text-white">▲</button>
                            <button id="btn-nav-select" class="nav-btn w-16 h-12 rounded-lg text-white font-bold">SELECT</button>
                            <button id="btn-nav-down" class="nav-btn w-10 h-10 rounded-full flex items-center justify-center text-2xl text-white">▼</button>
                        </div>
                        <button id="btn-snapshot" class="control-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg><span class="text-xs">Snapshot</span></button>
                        <button id="btn-nibp-start" class="control-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2.7 10.3a2.41 2.41 0 0 0 0 3.41 2.41 2.41 0 0 0 3.41 0L8 12l-1.89-1.89a2.41 2.41 0 0 0-3.41 0z"></path><path d="M21.3 13.7a2.41 2.41 0 0 0 0-3.41 2.41 2.41 0 0 0-3.41 0L16 12l1.89 1.89a2.41 2.41 0 0 0 3.41 0z"></path><path d="M12 3v18"></path></svg><span class="text-xs">NIBP</span></button>
                    </div>
                </div>

                <div class="bg-zoll-body-blue p-3 rounded-b-xl flex justify-center items-center gap-4 mt-1 border-t-2 border-gray-900">
                    <div class="flex items-center gap-2">
                        <div class="flex flex-col items-center"><div class="led led-off" id="aux-power-led"></div><span class="text-xs text-gray-400">AUX</span></div>
                        <div class="flex flex-col items-center"><div class="led led-off" id="battery-charge-led"></div><span class="text-xs text-gray-400">BATT</span></div>
                    </div>
                    <button id="btn-pacer-toggle" class="therapy-btn btn-green">PACER</button>
                    <button id="btn-analyze" class="therapy-btn btn-yellow">ANALYZE</button>
                    <div class="flex flex-col items-center">
                        <span class="text-xs text-white">ENERGY SELECT</span>
                        <div class="flex gap-2">
                            <button id="btn-energy-down" class="therapy-btn btn-yellow text-2xl w-12 h-12 flex items-center justify-center">▼</button>
                            <button id="btn-energy-up" class="therapy-btn btn-yellow text-2xl w-12 h-12 flex items-center justify-center">▲</button>
                        </div>
                    </div>
                    <button id="btn-charge" class="therapy-btn btn-yellow">CHARGE</button>
                    <div class="flex items-center gap-2">
                        <span class="text-2xl font-bold text-white">3</span>
                        <button id="btn-shock" class="shock-btn btn-red disabled:opacity-50 disabled:cursor-not-allowed" disabled>⚡</button>
                    </div>
                </div>
                 <div id="defib-status-container" class="text-center text-white font-bold mt-2 h-6"></div>
            </div>
        </div>
    </div>

    <script>
    // --- STATE, CONFIG, AND INITIALIZATION ---
    let state = {};
    let db, auth;
    let unsubscribePatient;
    let cprTimerInterval;

    const INITIAL_STATE = {
        sessionId: null,
        patient: {
            vitals: { hr: 80, spo2: 98, etco2: 38, resp: 12, temp: 98.6, nibp: "120/80", nibpMean: 93, lastNIBPTime: null },
            ecg: { rhythm: 'NSR', lead: 'II' },
            capno: { active: true },
            alarms: { active: [], silenced: false, suspended: false },
            deviceState: {
                mode: 'AED', // AED, Monitor, ManualDefib, Pacer
                defib: { energy: 120, status: 'disarmed', sync: false },
                pacer: { active: false, mode: 'Demand', rate: 70, output: 50 },
                nibpInterval: 0, // 0 for manual
                cprTimeRemaining: 120,
            },
            events: []
        },
        ui: {
            isCharging: false, chargeStartTime: 0, chargeDuration: 4000, 
            elapsedTimeCounter: 0, lastRWaveTime: 0,
            highlightedParamIndex: 0,
        }
    };

    function resetState() {
        state = JSON.parse(JSON.stringify(INITIAL_STATE));
        if (cprTimerInterval) clearInterval(cprTimerInterval);
    }
    
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    // ... playBeep function ...

    function initializeAppState(signInAnonymously, onAuthStateChanged) {
        if (!window.firebaseServices) {
            console.error("Firebase services not available.");
            document.getElementById('session-modal').innerHTML = '<div class="bg-red-500 p-8 rounded-lg shadow-2xl text-white w-full max-w-md"><h2 class="text-2xl font-bold mb-4">Firebase Not Configured</h2><p>Please provide your Firebase project configuration in the script tag.</p></div>';
            return;
        }
        auth = window.firebaseServices.auth;
        db = window.firebaseServices.db;
        onAuthStateChanged(auth, user => {
            if (user) {
                console.log("Authenticated anonymously:", user.uid);
            } else {
                signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error));
            }
        });
    }

    async function connectToSession(sessionId) {
        if (unsubscribePatient) unsubscribePatient();
        resetState();
        state.sessionId = sessionId;
        const patientDocRef = window.firebaseServices.doc(db, `zoll-sim-sessions/${sessionId}`);
        
        unsubscribePatient = window.firebaseServices.onSnapshot(patientDocRef, (doc) => {
            if (doc.exists()) {
                state.patient = { ...state.patient, ...doc.data() };
            } else {
                window.firebaseServices.setDoc(patientDocRef, state.patient);
            }
            updateUI();
        }, (error) => console.error("Error listening to patient document:", error));
        document.getElementById('session-modal').classList.add('hidden');
        document.getElementById('zoll-device').classList.remove('hidden');
    }
    
    // ... updateRemoteState and logEvent functions ...
    
    // --- UI LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
        // ... all button event listeners ...
        document.getElementById('btn-nav-up').addEventListener('click', () => navigateParams(-1));
        document.getElementById('btn-nav-down').addEventListener('click', () => navigateParams(1));
        document.getElementById('btn-nav-select').addEventListener('click', selectParam);
    });

    // --- CORE LOGIC & ALGORITHMS ---
    function setMode(newMode) {
        if (state.patient.deviceState.mode === newMode) return;
        
        // Logic for exiting current mode
        if (state.patient.deviceState.mode === 'AED') {
            if (cprTimerInterval) clearInterval(cprTimerInterval);
        }
        
        // Logic for entering new mode
        const updates = {'deviceState.mode': newMode};
        if (newMode === 'AED') {
            updates['deviceState.defib.status'] = 'disarmed';
            updates['deviceState.cprTimeRemaining'] = 120;
        } else if (newMode === 'Pacer') {
            updates['deviceState.pacer.active'] = true;
        } else if (newMode === 'Monitor' && state.patient.deviceState.pacer.active) {
            updates['deviceState.pacer.active'] = false;
        }

        updateRemoteState(updates);
        logEvent(`Mode changed to ${newMode}`);
    }

    function analyzeRhythm() {
        if (state.patient.deviceState.mode !== 'AED' && state.patient.deviceState.mode !== 'ManualDefib') return;
        logEvent("Rhythm analysis started");
        updateRemoteState({'deviceState.defib.status': 'analyzing'});
        setTimeout(() => {
            const rhythm = state.patient.ecg.rhythm;
            const shockAdvised = ['VF', 'VT'].includes(rhythm);
            updateRemoteState({'deviceState.defib.status': shockAdvised ? 'shock_advised' : 'no_shock_advised'});
            logEvent(`Analysis complete: ${shockAdvised ? 'Shock advised' : 'No shock advised'}`);
            
            if (state.patient.deviceState.mode === 'AED') {
                if (shockAdvised) {
                    chargeDefib();
                } else {
                    startCPRTimer();
                }
            }
        }, 5000);
    }
    
    function deliverShock() {
        if (state.patient.deviceState.defib.status !== 'charged') return;
        // ... shock delivery visual/audio logic ...
        logEvent(`Shock delivered`, { energy: state.patient.deviceState.defib.energy, sync: state.patient.deviceState.defib.sync });
        const newRhythm = (['VF', 'VT'].includes(state.patient.ecg.rhythm)) ? 'Asystole' : state.patient.ecg.rhythm;
        const updates = { 'deviceState.defib.status': 'disarmed', 'ecg.rhythm': newRhythm };
        if (!state.patient.deviceState.defib.sync) { updates['deviceState.defib.sync'] = false; }
        
        updateRemoteState(updates).then(() => {
            if (state.patient.deviceState.mode === 'AED') {
                startCPRTimer();
            }
        });
    }

    function startCPRTimer() {
        if (cprTimerInterval) clearInterval(cprTimerInterval);
        updateRemoteState({'deviceState.cprTimeRemaining': 120});
        cprTimerInterval = setInterval(() => {
            if(!state.patient.deviceState) return;
            const newTime = state.patient.deviceState.cprTimeRemaining - 1;
            if (newTime >= 0) {
                // To avoid flooding Firestore, only update every few seconds or let the client handle countdown display
                if (newTime % 5 === 0 || newTime < 5) {
                    updateRemoteState({'deviceState.cprTimeRemaining': newTime});
                } else {
                    state.patient.deviceState.cprTimeRemaining = newTime;
                    updateUI();
                }
            } else {
                clearInterval(cprTimerInterval);
                analyzeRhythm(); // Restart AED cycle
            }
        }, 1000);
    }

    function startNIBP() {
        if (Date.now() - (state.patient.vitals.lastNIBPTime || 0) < 15000) return;
        logEvent("NIBP measurement started");
        const updates = { 'vitals.lastNIBPTime': serverTimestamp() };
        updateRemoteState(updates);
    }

    function navigateParams(direction) {
        const params = document.querySelectorAll('.nav-target');
        if (params.length === 0) return;
        params[state.ui.highlightedParamIndex].classList.remove('highlighted-param');
        state.ui.highlightedParamIndex = (state.ui.highlightedParamIndex + direction + params.length) % params.length;
        params[state.ui.highlightedParamIndex].classList.add('highlighted-param');
    }

    function selectParam() {
        const params = document.querySelectorAll('.nav-target');
        if (params.length === 0) return;
        const selectedParam = params[state.ui.highlightedParamIndex];
        if (selectedParam.id === 'nibp-val-container') {
            const newInterval = prompt("Set NIBP Interval (minutes, 0 for manual):", state.patient.deviceState.nibpInterval);
            if (newInterval !== null && !isNaN(newInterval)) {
                updateRemoteState({'deviceState.nibpInterval': parseInt(newInterval)});
                logEvent(`NIBP interval set to ${newInterval} minutes`);
            }
        }
    }
    // ... other logic functions (changeEnergy, togglePacer, etc.) ...
    
    // --- UI & CANVAS RENDERING ---
    function updateUI() {
        if (!state.patient) return;
        const { mode } = state.patient.deviceState;
        
        // Toggle Views
        document.getElementById('monitor-view').classList.toggle('hidden', mode === 'AED' || mode === 'ManualDefib');
        document.getElementById('manual-defib-view').classList.toggle('hidden', mode !== 'ManualDefib');
        document.getElementById('aed-view').classList.toggle('hidden', mode !== 'AED');

        // Mode-specific UI updates
        if (mode === 'AED') {
            updateAEDView();
        } else if (mode === 'ManualDefib') {
            updateManualDefibView();
        } else { // Monitor or Pacer
            updateMonitorView();
        }
    }

    function updateAEDView() {
        const aedContainer = document.getElementById('aed-view');
        const { status } = state.patient.deviceState.defib;
        const { cprTimeRemaining } = state.patient.deviceState;
        let html = '';
        switch(status) {
            case 'disarmed':
                html = `<div class="text-3xl font-bold bg-green-700 p-4 rounded-lg">ATTACH PADS</div>`;
                break;
            case 'analyzing':
                html = `<div class="text-3xl font-bold bg-blue-700 p-4 rounded-lg">ANALYZING ECG</div><div class="mt-4 text-2xl">STAND CLEAR</div>`;
                break;
            case 'shock_advised':
                html = `<div class="text-3xl font-bold bg-white text-red-600 p-4 rounded-lg">SHOCK ADVISED</div><div class="mt-4 text-2xl">PRESS SHOCK</div>`;
                break;
            case 'no_shock_advised':
            case 'charged': // This state is technically skipped in AED, shock is immediate, but we use it post-shock for CPR
                const minutes = Math.floor(cprTimeRemaining / 60);
                const seconds = String(cprTimeRemaining % 60).padStart(2, '0');
                html = `<div class="text-3xl font-bold bg-blue-700 p-4 rounded-lg">PERFORM CPR</div><div class="mt-4 text-5xl font-mono">${minutes}:${seconds}</div>`;
                if(status === 'no_shock_advised' && cprTimeRemaining === 120) {
                     html += `<div class="absolute bottom-4 text-xl bg-green-700 p-2 rounded">NO SHOCK ADVISED</div>`
                }
                break;
            default:
                html = '';
        }
        aedContainer.innerHTML = html;
        updateDefibStatus();
    }
    
    function updateManualDefibView() {
        // logic to update the manual defib screen, including energy ladder
        updateDefibStatus();
    }
    
    function updateMonitorView() {
        const { vitals } = state.patient;
        document.getElementById('hr-val').textContent = vitals.hr;
        document.getElementById('spo2-val').textContent = vitals.spo2;
        document.getElementById('nibp-val').textContent = vitals.nibp;
        document.getElementById('nibp-mean-val').textContent = `(${vitals.nibpMean})`;
        document.getElementById('etco2-val').textContent = vitals.etco2;
        document.getElementById('resp-val').textContent = vitals.resp;
        // logic to update alarms etc in monitor view
        updateDefibStatus();
    }

    function updateDefibStatus() {
        // universal logic to update the bottom defib status text and buttons
    }

    // ... animationLoop with advanced waveform generation ...

    const canvases = {
        main: { el: document.getElementById('waveform-canvas'), ctx: document.getElementById('waveform-canvas').getContext('2d') },
        manual: { el: document.getElementById('manual-defib-canvas'), ctx: document.getElementById('manual-defib-canvas').getContext('2d') },
        '12lead': { el: document.getElementById('12-lead-canvas'), ctx: document.getElementById('12-lead-canvas').getContext('2d') }
    };

    function resizeAllCanvas() {
        for (const key in canvases) {
            const canvasInfo = canvases[key];
            if (canvasInfo.el && canvasInfo.el.parentElement) {
                const width = canvasInfo.el.parentElement.clientWidth;
                const height = canvasInfo.el.parentElement.clientHeight;
                canvasInfo.el.width = width;
                canvasInfo.el.height = height;
            }
        }
    }
    window.addEventListener('resize', resizeAllCanvas);

    function animationLoop(timestamp) {
        // animation logic
        requestAnimationFrame(animationLoop);
    }
    
    // Initial calls
    resetState();
    resizeAllCanvas();
    requestAnimationFrame(animationLoop);
    </script>
</body>
</html>
